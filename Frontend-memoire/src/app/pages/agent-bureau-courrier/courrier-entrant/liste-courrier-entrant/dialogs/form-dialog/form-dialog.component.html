<div class="dialog-header" fxLayout="row" fxLayoutAlign="space-between center">
  <h1 mat-dialog-title class="dialog-title">
    {{ action === 'edit' ? 'Modifier le courrier' : 'Ajouter un courrier' }}
  </h1>
</div>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="advanceTableForm" fxLayout="column" fxLayoutGap="16px" (click)="submit()" class="courrier-form">

    <!-- Section Informations principales -->
    <div class="form-section" fxLayout="column" fxLayoutGap="10px">
      <h3 class="section-title">Informations principales</h3>

      <div fxLayout="row" fxLayout.lt-md="column" fxLayoutGap="16px">
        <mat-form-field fxFlex appearance="outline">
          <mat-label>Date d'arrivée</mat-label>
          <mat-icon matPrefix>event</mat-icon>
          <input matInput [matDatepicker]="picker" formControlName="dateArrivee" required>
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="advanceTableForm.get('dateArrivee')?.hasError('required')">
            La date d'arrivée est requise
          </mat-error>
        </mat-form-field>

        <mat-form-field fxFlex appearance="outline">
          <mat-label>Nombre de fichiers</mat-label>
          <mat-icon matPrefix>attach_file</mat-icon>
          <input matInput formControlName="nbre_fichiers" [value]="selectedFiles?.length || 0" readonly>
        </mat-form-field>
      </div>

      <div fxLayout="row" fxLayout.lt-md="column" fxLayoutGap="16px">
        <mat-form-field fxFlex appearance="outline">
          <mat-label>Expéditeur</mat-label>
          <mat-icon matPrefix>person</mat-icon>
          <input matInput formControlName="expediteur" placeholder="Nom de l'expéditeur" required>
          <mat-error *ngIf="advanceTableForm.get('expediteur')?.hasError('required')">
            L'expéditeur est requis
          </mat-error>
        </mat-form-field>

        <mat-form-field fxFlex appearance="outline">
          <mat-label>Type de courrier</mat-label>
          <mat-icon matPrefix>security</mat-icon>
          <mat-select formControlName="niveauConfidentiel" required>
            <mat-option value="ORDINAIRE">
              <mat-icon>public</mat-icon>
              ORDINAIRE
            </mat-option>
            <mat-option value="CONFIDENTIEL">
              <mat-icon>lock</mat-icon>
              CONFIDENTIEL
            </mat-option>
          </mat-select>
          <mat-error *ngIf="advanceTableForm.get('niveauConfidentiel')?.hasError('required')">
            Le type de courrier est requis
          </mat-error>
        </mat-form-field>
      </div>

      <mat-form-field fxFlexFill appearance="outline">
        <mat-label>Objet du courrier</mat-label>
        <mat-icon matPrefix>subject</mat-icon>
        <input matInput formControlName="objet" placeholder="Saisissez l'objet du courrier" required>
        <mat-error *ngIf="advanceTableForm.get('objet')?.hasError('required')">
          L'objet est requis
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Section Upload de fichiers -->
    <div class="form-section" fxLayout="column" fxLayoutGap="10px">
      <h3 class="section-title" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
        <span>Pièces jointes</span>
      </h3>

      <div class="upload-container" fxLayout="column" fxLayoutGap="8px">
        <div class="dropzone"
             [class.dragover]="isDragOver"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)"
             (click)="fileInput.click()"
             fxLayout="column" fxLayoutAlign="center center">

          <div class="upload-content" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="8px">
            <mat-icon class="upload-icon">cloud_upload</mat-icon>
            <p class="upload-text">Glissez-déposez vos fichiers ici</p>
          </div>

          <input #fileInput
                 type="file"
                 style="display: none"
                 (change)="onFileSelected($event)"
                 accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                 multiple>
        </div>

        <div class="file-info" fxLayout="row" fxLayoutAlign="start center">
          <small class="file-types" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="4px">
            <mat-icon class="info-icon">info</mat-icon>
            <span>Formats acceptés: PDF, DOC, DOCX, JPG, JPEG, PNG</span>
          </small>
        </div>
      </div>

      <!-- Aperçu des fichiers sélectionnés -->
      <div class="files-preview" *ngIf="selectedFiles && selectedFiles.length > 0" fxLayout="column" fxLayoutGap="8px">
        <h4 class="preview-title" fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
          <mat-icon>attachment</mat-icon>
          <span>Fichiers sélectionnés ({{ selectedFiles.length }})</span>
        </h4>

        <div class="file-list" fxLayout="column" fxLayoutGap="8px">
          <mat-card *ngFor="let file of selectedFiles; let i = index" fxLayout="row" fxLayoutAlign="space-between center">
            <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="8px">
              <mat-icon class="file-icon">description</mat-icon>
              <div fxLayout="column">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
              </div>
            </div>
            <button type="button"
                    mat-icon-button
                    color="warn"
                    (click)="removeFile(i)"
                    matTooltip="Supprimer le fichier">
              <mat-icon>delete</mat-icon>
            </button>
          </mat-card>
        </div>
      </div>
    </div>

    <!-- Champs cachés -->
    <input type="hidden" formControlName="fichier_joint">
  </form>
</mat-dialog-content>

<mat-dialog-actions fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="8px">
  <button mat-button
          (click)="onNoClick()"
          class="cancel-btn">
    <mat-icon>close</mat-icon>
    Annuler
  </button>

  <button mat-raised-button
          color="primary"
          [disabled]="!advanceTableForm.valid"
          [mat-dialog-close]="1"
          (click)="confirmAdd()"
          class="submit-btn">
    <mat-icon>{{ action === 'edit' ? 'edit' : 'add' }}</mat-icon>
    {{ action === 'edit' ? 'Modifier' : 'Ajouter' }}
  </button>
</mat-dialog-actions>